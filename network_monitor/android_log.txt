inspur-itgw:/ # ifconfig
lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope: Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:4 errors:0 dropped:0 overruns:0 frame:0
          TX packets:4 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:200 TX bytes:200

sipa_dummy0 Link encap:Ethernet  HWaddr 12:ca:2f:f3:71:be
          inet6 addr: fe80::10ca:2fff:fef3:71be/64 Scope: Link
          UP RUNNING  MTU:1500  Metric:1
          RX packets:42 errors:0 dropped:0 overruns:0 frame:0
          TX packets:9 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:8831 TX bytes:726

dummy0    Link encap:Ethernet  HWaddr 9a:81:5f:63:e0:1b
          inet6 addr: fe80::9881:5fff:fe63:e01b/64 Scope: Link
          UP BROADCAST RUNNING NOARP  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:3 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 TX bytes:210

sipa_eth0 Link encap:UNSPEC
          inet addr:10.179.151.28  Mask:255.0.0.0
          inet6 addr: 2409:8970:b8b:a16:501d:65ff:fe25:3852/64 Scope: Global
          inet6 addr: fe80::1829:4462:fd78:1c80/64 Scope: Link
          UP RUNNING NOARP  MTU:1400  Metric:1
          RX packets:42 errors:0 dropped:0 overruns:0 frame:0
          TX packets:70 errors:1 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:8831 TX bytes:7746

eth0      Link encap:Ethernet  HWaddr 8a:30:79:32:45:96  Driver r8168
          inet addr:10.180.146.45  Bcast:10.180.146.255  Mask:255.255.255.0
          inet6 addr: 2040::f86e:a718:6348:f413/64 Scope: Global
          inet6 addr: fe80::5d65:a3e4:8854:8a2e/64 Scope: Link
          inet6 addr: 2040::18c3:8d28:53ce:c711/64 Scope: Global
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:44 errors:0 dropped:0 overruns:0 frame:0
          TX packets:48 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:6027 TX bytes:5123
          Interrupt:125 Base address:0xd000

docker0   Link encap:Ethernet  HWaddr 02:42:f2:7b:15:98
          inet addr:172.17.0.1  Bcast:172.17.255.255  Mask:255.255.0.0
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:0 TX bytes:0

inspur-itgw:/ # [   47.804958]c6 [ T1215] systemserver cmd2 , get para: ( 50)
ip rule
0:      from all lookup local
1004:   from 172.17.0.0/16 lookup eth0
1004:   from all to 172.17.0.0/16 lookup eth0
10000:  from all fwmark 0xc0000/0xd0000 lookup legacy_system
11000:  from all iif lo oif dummy0 uidrange 0-0 lookup dummy0
11000:  from all iif lo oif sipa_eth0 uidrange 0-0 lookup sipa_eth0
11000:  from all iif lo oif eth0 uidrange 0-0 lookup eth0
16000:  from all fwmark 0x10063/0x1ffff iif lo lookup local_network
16000:  from all fwmark 0x10064/0x1ffff iif lo lookup sipa_eth0
16000:  from all fwmark 0x10065/0x1ffff iif lo lookup eth0
17000:  from all iif lo oif dummy0 lookup dummy0
17000:  from all iif lo oif sipa_eth0 lookup sipa_eth0
17000:  from all iif lo oif eth0 lookup eth0
18000:  from all fwmark 0x0/0x10000 lookup legacy_system
19000:  from all fwmark 0x0/0x10000 lookup legacy_network
20000:  from all fwmark 0x0/0x10000 lookup local_network
23000:  from all fwmark 0x64/0x1ffff iif lo lookup sipa_eth0
23000:  from all fwmark 0x65/0x1ffff iif lo lookup eth0
31000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
32000:  from all unreachable
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ # ping baidu.com
PING baidu.com (39.156.66.10) 56(84) bytes of data.
64 bytes from 39.156.66.10 (39.156.66.10): icmp_seq=1 ttl=51 time=99.2 ms
^C
--- baidu.com ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 99.232/99.232/99.232/0.000 ms
inspur-itgw:/ # ip route get [   77.812895]c3 [ T1215] systemserver cmd2 , get para: ( 50)
39.156.66.10
39.156.66.10 dev sipa_eth0 table sipa_eth0 src 10.179.151.28 uid 0
    cache mtu 1400
inspur-itgw:/ # [  107.821252]c3 [ T1215] systemserver cmd2 , get para: ( 50)
ipta
iptables                  iptables-save
iptables-restore          iptables-wrapper-1.0
inspur-itgw:/ # iptables-save
# Generated by iptables-save v1.8.7 on Mon Mar  3 18:33:27 2025
*security
:INPUT ACCEPT [225:45630]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [225:18744]
COMMIT
# Completed on Mon Mar  3 18:33:27 2025
# Generated by iptables-save v1.8.7 on Mon Mar  3 18:33:27 2025
*raw
:PREROUTING ACCEPT [244:48545]
:OUTPUT ACCEPT [223:18616]
:bw_raw_PREROUTING - [0:0]
:idletimer_raw_PREROUTING - [0:0]
:tetherctrl_raw_PREROUTING - [0:0]
-A PREROUTING -j idletimer_raw_PREROUTING
-A PREROUTING -j bw_raw_PREROUTING
-A PREROUTING -j tetherctrl_raw_PREROUTING
-A bw_raw_PREROUTING -m mark --mark 0xdeadc1a7 -j DROP
-A bw_raw_PREROUTING -i ipsec+ -j RETURN
-A bw_raw_PREROUTING -m policy --dir in --pol ipsec -j RETURN
-A bw_raw_PREROUTING -m bpf --object-pinned /sys/fs/bpf/netd_shared/prog_netd_skfilter_ingress_xtbpf
-A idletimer_raw_PREROUTING -i sipa_eth0 -j IDLETIMER --timeout 10 --label 0 --send_nl_msg
COMMIT
# Completed on Mon Mar  3 18:33:27 2025
# Generated by iptables-save v1.8.7 on Mon Mar  3 18:33:27 2025
*nat
:PREROUTING ACCEPT [58:7265]
:INPUT ACCEPT [39:4350]
:OUTPUT ACCEPT [65:4319]
:POSTROUTING ACCEPT [65:4319]
:DOCKER - [0:0]
:oem_nat_pre - [0:0]
:tetherctrl_nat_POSTROUTING - [0:0]
-A PREROUTING -j oem_nat_pre
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
-A POSTROUTING -j tetherctrl_nat_POSTROUTING
-A DOCKER -i docker0 -j RETURN
COMMIT
# Completed on Mon Mar  3 18:33:27 2025
# Generated by iptables-save v1.8.7 on Mon Mar  3 18:33:27 2025
*mangle
:PREROUTING ACCEPT [204:38147]
:INPUT ACCEPT [188:37255]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [167:13206]
:POSTROUTING ACCEPT [167:13206]
:bw_mangle_POSTROUTING - [0:0]
:idletimer_mangle_POSTROUTING - [0:0]
:oem_mangle_post - [0:0]
:routectrl_mangle_INPUT - [0:0]
:tetherctrl_mangle_FORWARD - [0:0]
:wakeupctrl_mangle_INPUT - [0:0]
-A INPUT -j wakeupctrl_mangle_INPUT
-A INPUT -j routectrl_mangle_INPUT
-A FORWARD -j tetherctrl_mangle_FORWARD
-A POSTROUTING -j oem_mangle_post
-A POSTROUTING -j bw_mangle_POSTROUTING
-A POSTROUTING -j idletimer_mangle_POSTROUTING
-A bw_mangle_POSTROUTING -o ipsec+ -j RETURN
-A bw_mangle_POSTROUTING -m policy --dir out --pol ipsec -j RETURN
-A bw_mangle_POSTROUTING -j MARK --set-xmark 0x0/0x100000
-A bw_mangle_POSTROUTING -m bpf --object-pinned /sys/fs/bpf/netd_shared/prog_netd_skfilter_egress_xtbpf
-A idletimer_mangle_POSTROUTING -o sipa_eth0 -j IDLETIMER --timeout 10 --label 0 --send_nl_msg
-A routectrl_mangle_INPUT -i sipa_eth0 -j MARK --set-xmark 0x30064/0xffefffff
-A routectrl_mangle_INPUT -i eth0 -j MARK --set-xmark 0x30065/0xffefffff
-A tetherctrl_mangle_FORWARD -p tcp -m tcp --tcp-flags SYN SYN -j TCPMSS --clamp-mss-to-pmtu
COMMIT
# Completed on Mon Mar  3 18:33:27 2025
# Generated by iptables-save v1.8.7 on Mon Mar  3 18:33:27 2025
*filter
:INPUT ACCEPT [185:37065]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [163:12933]
:DOCKER - [0:0]
:DOCKER-ISOLATION-STAGE-1 - [0:0]
:DOCKER-ISOLATION-STAGE-2 - [0:0]
:DOCKER-USER - [0:0]
:bw_FORWARD - [0:0]
:bw_INPUT - [0:0]
:bw_OUTPUT - [0:0]
:bw_costly_shared - [0:0]
:bw_costly_sipa_eth0 - [0:0]
:bw_data_saver - [0:0]
:bw_global_alert - [0:0]
:bw_happy_box - [0:0]
:bw_penalty_box - [0:0]
:fw_FORWARD - [0:0]
:fw_INPUT - [0:0]
:fw_OUTPUT - [0:0]
:oem_fwd - [0:0]
:oem_out - [0:0]
:st_OUTPUT - [0:0]
:st_clear_caught - [0:0]
:st_clear_detect - [0:0]
:st_penalty_log - [0:0]
:st_penalty_reject - [0:0]
:tetherctrl_FORWARD - [0:0]
:tetherctrl_counters - [0:0]
-A INPUT -j bw_INPUT
-A INPUT -j fw_INPUT
-A FORWARD -j DOCKER-USER
-A FORWARD -j DOCKER-ISOLATION-STAGE-1
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -o docker0 -j DOCKER
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT
-A FORWARD -j oem_fwd
-A FORWARD -j fw_FORWARD
-A FORWARD -j bw_FORWARD
-A FORWARD -j tetherctrl_FORWARD
-A OUTPUT -j oem_out
-A OUTPUT -j fw_OUTPUT
-A OUTPUT -j st_OUTPUT
-A OUTPUT -j bw_OUTPUT
-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2
-A DOCKER-ISOLATION-STAGE-1 -j RETURN
-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP
-A DOCKER-ISOLATION-STAGE-2 -j RETURN
-A DOCKER-USER -j RETURN
-A bw_FORWARD -i sipa_eth0 -j bw_costly_sipa_eth0
-A bw_FORWARD -o sipa_eth0 -j bw_costly_sipa_eth0
-A bw_INPUT -j bw_global_alert
-A bw_INPUT -i sipa_eth0 -j bw_costly_sipa_eth0
-A bw_INPUT -p esp -j RETURN
-A bw_INPUT -m mark --mark 0x100000/0x100000 -j RETURN
-A bw_INPUT -j MARK --set-xmark 0x100000/0x100000
-A bw_OUTPUT -j bw_global_alert
-A bw_OUTPUT -o sipa_eth0 -j bw_costly_sipa_eth0
-A bw_costly_shared -j bw_penalty_box
-A bw_costly_sipa_eth0 -j bw_penalty_box
-A bw_costly_sipa_eth0 -m quota2 ! --name sipa_eth0  --quota 9223372036854775807  -j REJECT --reject-with icmp-port-unreachable
-A bw_data_saver -j RETURN
-A bw_global_alert -m quota2 ! --name globalAlert  --quota 2097152
-A bw_happy_box -m bpf --object-pinned /sys/fs/bpf/netd_shared/prog_netd_skfilter_allowlist_xtbpf -j RETURN
-A bw_happy_box -j bw_data_saver
-A bw_penalty_box -m bpf --object-pinned /sys/fs/bpf/netd_shared/prog_netd_skfilter_denylist_xtbpf -j REJECT --reject-with icmp-port-unreachable
-A bw_penalty_box -j bw_happy_box
-A st_clear_detect -m connmark --mark 0x2000000/0x2000000 -j REJECT --reject-with icmp-port-unreachable
-A st_clear_detect -m connmark --mark 0x1000000/0x1000000 -j RETURN
-A st_clear_detect -p tcp -m u32 --u32 "0x0>>0x16&0x3c@0xc>>0x1a&0x3c@0x0&0xffff0000=0x16030000&&0x0>>0x16&0x3c@0xc>>0x1a&0x3c@0x4&0xff0000=0x10000" -j CONNMARK --set-xmark 0x1000000/0x1000000
-A st_clear_detect -p udp -m u32 --u32 "0x0>>0x16&0x3c@0x8&0xffff0000=0x16fe0000&&0x0>>0x16&0x3c@0x14&0xff0000=0x10000" -j CONNMARK --set-xmark 0x1000000/0x1000000
-A st_clear_detect -m connmark --mark 0x1000000/0x1000000 -j RETURN
-A st_clear_detect -p tcp -m state --state ESTABLISHED -m u32 --u32 "0x0>>0x16&0x3c@0xc>>0x1a&0x3c@0x0&0x0=0x0" -j st_clear_caught
-A st_clear_detect -p udp -j st_clear_caught
-A st_penalty_log -j CONNMARK --set-xmark 0x1000000/0x1000000
-A st_penalty_log -j NFLOG
-A st_penalty_reject -j CONNMARK --set-xmark 0x2000000/0x2000000
-A st_penalty_reject -j NFLOG
-A st_penalty_reject -j REJECT --reject-with icmp-port-unreachable
-A tetherctrl_FORWARD -j DROP
COMMIT
# Completed on Mon Mar  3 18:33:28 2025
inspur-itgw:/ # [  137.829652]c3 [ T1215] systemserver cmd2 , get para: ( 50)
[  167.838526]c1 [ T1215] systemserver cmd2 , get para: ( 50)
[  197.846343]c1 [ T1215] systemserver cmd2 , get para: ( 50)

inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ # ip route get 39.156.66.10
39.156.66.10 dev sipa_eth0 table sipa_eth0 src 10.179.151.28 uid 0
    cache mtu 1400
inspur-itgw:/ # ip rule show
0:      from all lookup local
1004:   from 172.17.0.0/16 lookup eth0
1004:   from all to 172.17.0.0/16 lookup eth0
10000:  from all fwmark 0xc0000/0xd0000 lookup legacy_system
11000:  from all iif lo oif dummy0 uidrange 0-0 lookup dummy0
11000:  from all iif lo oif sipa_eth0 uidrange 0-0 lookup sipa_eth0
11000:  from all iif lo oif eth0 uidrange 0-0 lookup eth0
16000:  from all fwmark 0x10063/0x1ffff iif lo lookup local_network
16000:  from all fwmark 0x10064/0x1ffff iif lo lookup sipa_eth0
16000:  from all fwmark 0x10065/0x1ffff iif lo lookup eth0
17000:  from all iif lo oif dummy0 lookup dummy0
17000:  from all iif lo oif sipa_eth0 lookup sipa_eth0
17000:  from all iif lo oif eth0 lookup eth0
18000:  from all fwmark 0x0/0x10000 lookup legacy_system
19000:  from all fwmark 0x0/0x10000 lookup legacy_network
20000:  from all fwmark 0x0/0x10000 lookup local_network
23000:  from all fwmark 0x64/0x1ffff iif lo lookup sipa_eth0
23000:  from all fwmark 0x65/0x1ffff iif lo lookup eth0
31000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
32000:  from all unreachable
inspur-itgw:/ #
inspur-itgw:/ # ip rule del [  227.854427]c1 [ T1215] systemserver cmd2 , get para: ( 50)
el from all fwmark 0x10064/0x1ffff iif lo lookup sipa_eth0                    <
inspur-itgw:/ # ip rule show
0:      from all lookup local
1004:   from 172.17.0.0/16 lookup eth0
1004:   from all to 172.17.0.0/16 lookup eth0
10000:  from all fwmark 0xc0000/0xd0000 lookup legacy_system
11000:  from all iif lo oif dummy0 uidrange 0-0 lookup dummy0
11000:  from all iif lo oif sipa_eth0 uidrange 0-0 lookup sipa_eth0
11000:  from all iif lo oif eth0 uidrange 0-0 lookup eth0
16000:  from all fwmark 0x10063/0x1ffff iif lo lookup local_network
16000:  from all fwmark 0x10065/0x1ffff iif lo lookup eth0
17000:  from all iif lo oif dummy0 lookup dummy0
17000:  from all iif lo oif sipa_eth0 lookup sipa_eth0
17000:  from all iif lo oif eth0 lookup eth0
18000:  from all fwmark 0x0/0x10000 lookup legacy_system
19000:  from all fwmark 0x0/0x10000 lookup legacy_network
20000:  from all fwmark 0x0/0x10000 lookup local_network
23000:  from all fwmark 0x64/0x1ffff iif lo lookup sipa_eth0
23000:  from all fwmark 0x65/0x1ffff iif lo lookup eth0
31000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
32000:  from all unreachable
inspur-itgw:/ # ip route get 39.156.66.10
39.156.66.10 dev sipa_eth0 table sipa_eth0 src 10.179.151.28 uid 0
    cache mtu 1400
inspur-itgw:/ # [  257.863783]c1 [ T1215] systemserver cmd2 , get para: ( 50)
[  287.872165]c1 [ T1215] systemserver cmd2 , get para: ( 50)
ip rule del from all iif lo oif sipa_eth0 lookup sipa_eth0
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ # ip rule show
0:      from all lookup local
1004:   from 172.17.0.0/16 lookup eth0
1004:   from all to 172.17.0.0/16 lookup eth0
10000:  from all fwmark 0xc0000/0xd0000 lookup legacy_system
11000:  from all iif lo oif dummy0 uidrange 0-0 lookup dummy0
11000:  from all iif lo oif eth0 uidrange 0-0 lookup eth0
16000:  from all fwmark 0x10063/0x1ffff iif lo lookup local_network
16000:  from all fwmark 0x10065/0x1ffff iif lo lookup eth0
17000:  from all iif lo oif dummy0 lookup dummy0
17000:  from all iif lo oif sipa_eth0 lookup sipa_eth0
17000:  from all iif lo oif eth0 lookup eth0
18000:  from all fwmark 0x0/0x10000 lookup legacy_system
19000:  from all fwmark 0x0/0x10000 lookup legacy_network
20000:  from all fwmark 0x0/0x10000 lookup local_network
23000:  from all fwmark 0x64/0x1ffff iif lo lookup sipa_eth0
23000:  from all fwmark 0x65/0x1ffff iif lo lookup eth0
31000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
32000:  from all unreachable
inspur-itgw:/ #
inspur-itgw:/ # ip route get 39.156.66.10
39.156.66.10 dev sipa_eth0 table sipa_eth0 src 10.179.151.28 uid 0
    cache mtu 1400
inspur-itgw:/ #
inspur-itgw:/ # [  317.881186]c1 [ T1215] systemserver cmd2 , get para: ( 50)

inspur-itgw:/ #
inspur-itgw:/ #
el from all fwmark 0x64/0x1ffff iif lo lookup sipa_eth0                       <
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ # ip rule show
0:      from all lookup local
1004:   from 172.17.0.0/16 lookup eth0
1004:   from all to 172.17.0.0/16 lookup eth0
10000:  from all fwmark 0xc0000/0xd0000 lookup legacy_system
11000:  from all iif lo oif dummy0 uidrange 0-0 lookup dummy0
11000:  from all iif lo oif eth0 uidrange 0-0 lookup eth0
16000:  from all fwmark 0x10063/0x1ffff iif lo lookup local_network
16000:  from all fwmark 0x10065/0x1ffff iif lo lookup eth0
17000:  from all iif lo oif dummy0 lookup dummy0
17000:  from all iif lo oif sipa_eth0 lookup sipa_eth0
17000:  from all iif lo oif eth0 lookup eth0
18000:  from all fwmark 0x0/0x10000 lookup legacy_system
19000:  from all fwmark 0x0/0x10000 lookup legacy_network
20000:  from all fwmark 0x0/0x10000 lookup local_network
23000:  from all fwmark 0x65/0x1ffff iif lo lookup eth0
31000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
32000:  from all unreachable
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ # ip route get 39.156.66.10
39.156.66.10 dev sipa_eth0 table sipa_eth0 src 10.179.151.28 uid 0
    cache mtu 1400
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ # ip rule del [  347.888846]c1 [ T1215] systemserver cmd2 , get para: ( 50)
el from all fwmark 0x0/0xffff iif lo lookup sipa_eth0                         <
inspur-itgw:/ #
inspur-itgw:/ #
inspur-itgw:/ # ip route get 39.156.66.10
RTNETLINK answers: Network is unreachable
2|inspur-itgw:/ #
2|inspur-itgw:/ # 


修改eth0的ip rule：
inspur-itgw:/ # ip rule
0:      from all lookup local
1004:   from 172.17.0.0/16 lookup eth0
1004:   from all to 172.17.0.0/16 lookup eth0
10000:  from all fwmark 0xc0000/0xd0000 lookup legacy_system
11000:  from all iif lo oif dummy0 uidrange 0-0 lookup dummy0
11000:  from all iif lo oif sipa_eth0 uidrange 0-0 lookup sipa_eth0
11000:  from all iif lo oif eth0 uidrange 0-0 lookup eth0
16000:  from all fwmark 0x10063/0x1ffff iif lo lookup local_network
16000:  from all fwmark 0x10064/0x1ffff iif lo lookup sipa_eth0
16000:  from all fwmark 0x10066/0x1ffff iif lo lookup eth0
17000:  from all iif lo oif dummy0 lookup dummy0
17000:  from all iif lo oif sipa_eth0 lookup sipa_eth0
17000:  from all iif lo oif eth0 lookup eth0
18000:  from all fwmark 0x0/0x10000 lookup legacy_system
19000:  from all fwmark 0x0/0x10000 lookup legacy_network
20000:  from all fwmark 0x0/0x10000 lookup local_network
23000:  from all fwmark 0x64/0x1ffff iif lo lookup sipa_eth0
23000:  from all fwmark 0x66/0x1ffff iif lo lookup eth0
31000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
32000:  from all unreachable
32000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
inspur-itgw:/ # ip route get 110.242.68.66
110.242.68.66 dev sipa_eth0 table sipa_eth0 src 10.217.40.134 uid 0
    cache mtu 1400
inspur-itgw:/ # [  497.621802]c2 [ T1220] systemserver cmd2 , get para: ( 50)
dd from all fwmark 0x0/0xffff iif lo lookup eth0 30000                        <
Error: argument "30000" is wrong: Failed to parse rule type
d from all fwmark 0x0/0xffff iif lo lookup eth0 pri 30000                     <
inspur-itgw:/ # ip rule
0:      from all lookup local
1004:   from 172.17.0.0/16 lookup eth0
1004:   from all to 172.17.0.0/16 lookup eth0
10000:  from all fwmark 0xc0000/0xd0000 lookup legacy_system
11000:  from all iif lo oif dummy0 uidrange 0-0 lookup dummy0
11000:  from all iif lo oif sipa_eth0 uidrange 0-0 lookup sipa_eth0
11000:  from all iif lo oif eth0 uidrange 0-0 lookup eth0
16000:  from all fwmark 0x10063/0x1ffff iif lo lookup local_network
16000:  from all fwmark 0x10064/0x1ffff iif lo lookup sipa_eth0
16000:  from all fwmark 0x10066/0x1ffff iif lo lookup eth0
17000:  from all iif lo oif dummy0 lookup dummy0
17000:  from all iif lo oif sipa_eth0 lookup sipa_eth0
17000:  from all iif lo oif eth0 lookup eth0
18000:  from all fwmark 0x0/0x10000 lookup legacy_system
19000:  from all fwmark 0x0/0x10000 lookup legacy_network
20000:  from all fwmark 0x0/0x10000 lookup local_network
23000:  from all fwmark 0x64/0x1ffff iif lo lookup sipa_eth0
23000:  from all fwmark 0x66/0x1ffff iif lo lookup eth0
30000:  from all fwmark 0x0/0xffff iif lo lookup eth0
31000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
32000:  from all unreachable
32000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
inspur-itgw:/ # [  527.628923]c3 [ T1220] systemserver cmd2 , get para: ( 50)

inspur-itgw:/ # ip rule
0:      from all lookup local
1004:   from 172.17.0.0/16 lookup eth0
1004:   from all to 172.17.0.0/16 lookup eth0
10000:  from all fwmark 0xc0000/0xd0000 lookup legacy_system
11000:  from all iif lo oif dummy0 uidrange 0-0 lookup dummy0
11000:  from all iif lo oif sipa_eth0 uidrange 0-0 lookup sipa_eth0
11000:  from all iif lo oif eth0 uidrange 0-0 lookup eth0
16000:  from all fwmark 0x10063/0x1ffff iif lo lookup local_network
16000:  from all fwmark 0x10064/0x1ffff iif lo lookup sipa_eth0
16000:  from all fwmark 0x10066/0x1ffff iif lo lookup eth0
17000:  from all iif lo oif dummy0 lookup dummy0
17000:  from all iif lo oif sipa_eth0 lookup sipa_eth0
17000:  from all iif lo oif eth0 lookup eth0
18000:  from all fwmark 0x0/0x10000 lookup legacy_system
19000:  from all fwmark 0x0/0x10000 lookup legacy_network
20000:  from all fwmark 0x0/0x10000 lookup local_network
23000:  from all fwmark 0x64/0x1ffff iif lo lookup sipa_eth0
23000:  from all fwmark 0x66/0x1ffff iif lo lookup eth0
30000:  from all fwmark 0x0/0xffff iif lo lookup eth0
31000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
32000:  from all unreachable
32000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
inspur-itgw:/ # ip route get 110.242.68.66
110.242.68.66 via 10.180.146.254 dev eth0 table eth0 src 10.180.146.46 uid 0
    cache
inspur-itgw:/ # [  557.636145]c3 [ T1220] systemserver cmd2 , get para: ( 50)



inspur-itgw:/ # iptables-save
# Generated by iptables-save v1.8.7 on Mon Mar  3 18:49:18 2025
*security
:INPUT ACCEPT [1054:257487]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [441:37384]
COMMIT
# Completed on Mon Mar  3 18:49:18 2025
# Generated by iptables-save v1.8.7 on Mon Mar  3 18:49:18 2025
*raw
:PREROUTING ACCEPT [1155:263862]
:OUTPUT ACCEPT [439:37256]
:bw_raw_PREROUTING - [0:0]
:idletimer_raw_PREROUTING - [0:0]
:tetherctrl_raw_PREROUTING - [0:0]
-A PREROUTING -j idletimer_raw_PREROUTING
-A PREROUTING -j bw_raw_PREROUTING
-A PREROUTING -j tetherctrl_raw_PREROUTING
-A bw_raw_PREROUTING -m mark --mark 0xdeadc1a7 -j DROP
-A bw_raw_PREROUTING -i ipsec+ -j RETURN
-A bw_raw_PREROUTING -m policy --dir in --pol ipsec -j RETURN
-A bw_raw_PREROUTING -m bpf --object-pinned /sys/fs/bpf/netd_shared/prog_netd_skfilter_ingress_xtbpf
-A idletimer_raw_PREROUTING -i sipa_eth0 -j IDLETIMER --timeout 10 --label 0 --send_nl_msg
COMMIT
# Completed on Mon Mar  3 18:49:18 2025
# Generated by iptables-save v1.8.7 on Mon Mar  3 18:49:18 2025
*nat
:PREROUTING ACCEPT [383:31365]
:INPUT ACCEPT [282:24990]
:OUTPUT ACCEPT [154:10432]
:POSTROUTING ACCEPT [154:10432]
:DOCKER - [0:0]
:oem_nat_pre - [0:0]
:tetherctrl_nat_POSTROUTING - [0:0]
-A PREROUTING -j oem_nat_pre
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
-A POSTROUTING -j tetherctrl_nat_POSTROUTING
-A DOCKER -i docker0 -j RETURN
COMMIT
# Completed on Mon Mar  3 18:49:18 2025
# Generated by iptables-save v1.8.7 on Mon Mar  3 18:49:18 2025
*mangle
:PREROUTING ACCEPT [311:75729]
:INPUT ACCEPT [288:74517]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [160:13186]
:POSTROUTING ACCEPT [160:13186]
:bw_mangle_POSTROUTING - [0:0]
:idletimer_mangle_POSTROUTING - [0:0]
:oem_mangle_post - [0:0]
:routectrl_mangle_INPUT - [0:0]
:tetherctrl_mangle_FORWARD - [0:0]
:wakeupctrl_mangle_INPUT - [0:0]
-A INPUT -j wakeupctrl_mangle_INPUT
-A INPUT -j routectrl_mangle_INPUT
-A FORWARD -j tetherctrl_mangle_FORWARD
-A POSTROUTING -j oem_mangle_post
-A POSTROUTING -j bw_mangle_POSTROUTING
-A POSTROUTING -j idletimer_mangle_POSTROUTING
-A bw_mangle_POSTROUTING -o ipsec+ -j RETURN
-A bw_mangle_POSTROUTING -m policy --dir out --pol ipsec -j RETURN
-A bw_mangle_POSTROUTING -j MARK --set-xmark 0x0/0x100000
-A bw_mangle_POSTROUTING -m bpf --object-pinned /sys/fs/bpf/netd_shared/prog_netd_skfilter_egress_xtbpf
-A idletimer_mangle_POSTROUTING -o sipa_eth0 -j IDLETIMER --timeout 10 --label 0 --send_nl_msg
-A routectrl_mangle_INPUT -i sipa_eth0 -j MARK --set-xmark 0x30064/0xffefffff
-A routectrl_mangle_INPUT -i eth0 -j MARK --set-xmark 0x30066/0xffefffff
-A tetherctrl_mangle_FORWARD -p tcp -m tcp --tcp-flags SYN SYN -j TCPMSS --clamp-mss-to-pmtu
/*
这段代码是iptables中mangle表POSTROUTING链的规则，用于处理网络数据包

1.
-A bw_mangle_POSTROUTING -o ipsec+ -j RETURN：这条规则表示，对于从ipsec+接口出去的数据包，直接返回，不进行后续的处理。ipsec+可能是一个支持IPSec的接口或者是一个IPSec策略的名称。

2.
-A bw_mangle_POSTROUTING -m policy --dir out --pol ipsec -j RETURN：这条规则表示，对于从本地发出的、匹配IPSec策略的数据包，直接返回，不进行后续的处理。

3.
-A bw_mangle_POSTROUTING -j MARK --set-xmark 0x0/0x100000：这条规则表示，对于所有经过POSTROUTING链的数据包，将其扩展标记（xmark）设置为0x0/0x100000。扩展标记是一种可以存储更多信息的标记，可以用于更复杂的路由决策。

4.
-A bw_mangle_POSTROUTING -m bpf --object-pinned /sys/fs/bpf/netd_shared/prog_netd_skfilter_egress_xtbpf：这条规则表示，对于所有经过POSTROUTING链的数据包，执行一个BPF（Berkeley Packet Filter）程序。BPF程序是一种可以在内核空间执行的程序，可以用于处理网络数据包。这里的BPF程序被固定在/sys/fs/bpf/netd_shared/prog_netd_skfilter_egress_xtbpf路径下。

总的来说，这段代码的作用是对经过POSTROUTING链的数据包进行一系列的处理，包括根据接口和策略返回数据包，设置扩展标记，以及执行BPF程序。
*/
COMMIT
# Completed on Mon Mar  3 18:49:18 2025
# Generated by iptables-save v1.8.7 on Mon Mar  3 18:49:18 2025
*filter
:INPUT ACCEPT [285:74327]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [157:12976]
:DOCKER - [0:0]
:DOCKER-ISOLATION-STAGE-1 - [0:0]
:DOCKER-ISOLATION-STAGE-2 - [0:0]
:DOCKER-USER - [0:0]
:bw_FORWARD - [0:0]
:bw_INPUT - [0:0]
:bw_OUTPUT - [0:0]
:bw_costly_shared - [0:0]
:bw_costly_sipa_eth0 - [0:0]
:bw_data_saver - [0:0]
:bw_global_alert - [0:0]
:bw_happy_box - [0:0]
:bw_penalty_box - [0:0]
:fw_FORWARD - [0:0]
:fw_INPUT - [0:0]
:fw_OUTPUT - [0:0]
:oem_fwd - [0:0]
:oem_out - [0:0]
:st_OUTPUT - [0:0]
:st_clear_caught - [0:0]
:st_clear_detect - [0:0]
:st_penalty_log - [0:0]
:st_penalty_reject - [0:0]
:tetherctrl_FORWARD - [0:0]
:tetherctrl_counters - [0:0]
-A INPUT -j bw_INPUT
-A INPUT -j fw_INPUT
-A FORWARD -j DOCKER-USER
-A FORWARD -j DOCKER-ISOLATION-STAGE-1
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -o docker0 -j DOCKER
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT
-A FORWARD -j oem_fwd
-A FORWARD -j fw_FORWARD
-A FORWARD -j bw_FORWARD
-A FORWARD -j tetherctrl_FORWARD
-A OUTPUT -j oem_out
-A OUTPUT -j fw_OUTPUT
-A OUTPUT -j st_OUTPUT
-A OUTPUT -j bw_OUTPUT
-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2
-A DOCKER-ISOLATION-STAGE-1 -j RETURN
-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP
-A DOCKER-ISOLATION-STAGE-2 -j RETURN
-A DOCKER-USER -j RETURN
-A bw_FORWARD -i sipa_eth0 -j bw_costly_sipa_eth0
-A bw_FORWARD -o sipa_eth0 -j bw_costly_sipa_eth0
-A bw_INPUT -j bw_global_alert
-A bw_INPUT -i sipa_eth0 -j bw_costly_sipa_eth0
-A bw_INPUT -p esp -j RETURN
-A bw_INPUT -m mark --mark 0x100000/0x100000 -j RETURN
-A bw_INPUT -j MARK --set-xmark 0x100000/0x100000
-A bw_OUTPUT -j bw_global_alert
-A bw_OUTPUT -o sipa_eth0 -j bw_costly_sipa_eth0
-A bw_costly_shared -j bw_penalty_box
-A bw_costly_sipa_eth0 -j bw_penalty_box
-A bw_costly_sipa_eth0 -m quota2 ! --name sipa_eth0  --quota 9223372036854775807  -j REJECT --reject-with icmp-port-unreachable
-A bw_data_saver -j RETURN
-A bw_global_alert -m quota2 ! --name globalAlert  --quota 2097152
-A bw_happy_box -m bpf --object-pinned /sys/fs/bpf/netd_shared/prog_netd_skfilter_allowlist_xtbpf -j RETURN
-A bw_happy_box -j bw_data_saver
-A bw_penalty_box -m bpf --object-pinned /sys/fs/bpf/netd_shared/prog_netd_skfilter_denylist_xtbpf -j REJECT --reject-with icmp-port-unreachable
-A bw_penalty_box -j bw_happy_box
-A st_clear_detect -m connmark --mark 0x2000000/0x2000000 -j REJECT --reject-with icmp-port-unreachable
-A st_clear_detect -m connmark --mark 0x1000000/0x1000000 -j RETURN
-A st_clear_detect -p tcp -m u32 --u32 "0x0>>0x16&0x3c@0xc>>0x1a&0x3c@0x0&0xffff0000=0x16030000&&0x0>>0x16&0x3c@0xc>>0x1a&0x3c@0x4&0xff0000=0x10000" -j CONNMARK --set-xmark 0x1000000/0x1000000
-A st_clear_detect -p udp -m u32 --u32 "0x0>>0x16&0x3c@0x8&0xffff0000=0x16fe0000&&0x0>>0x16&0x3c@0x14&0xff0000=0x10000" -j CONNMARK --set-xmark 0x1000000/0x1000000
-A st_clear_detect -m connmark --mark 0x1000000/0x1000000 -j RETURN
-A st_clear_detect -p tcp -m state --state ESTABLISHED -m u32 --u32 "0x0>>0x16&0x3c@0xc>>0x1a&0x3c@0x0&0x0=0x0" -j st_clear_caught
-A st_clear_detect -p udp -j st_clear_caught
-A st_penalty_log -j CONNMARK --set-xmark 0x1000000/0x1000000
-A st_penalty_log -j NFLOG
-A st_penalty_reject -j CONNMARK --set-xmark 0x2000000/0x2000000
-A st_penalty_reject -j NFLOG
-A st_penalty_reject -j REJECT --reject-with icmp-port-unreachable
-A tetherctrl_FORWARD -j DROP
COMMIT
# Completed on Mon Mar  3 18:49:18 2025
inspur-itgw:/ # iptables -t mangle -nvL
Chain PREROUTING (policy ACCEPT 325 packets, 80175 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain INPUT (policy ACCEPT 297 packets, 78686 bytes)
 pkts bytes target     prot opt in     out     source               destination
 1063  262K wakeupctrl_mangle_INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0
 1063  262K routectrl_mangle_INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 tetherctrl_mangle_FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0

Chain OUTPUT (policy ACCEPT 160 packets, 13186 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 160 packets, 13186 bytes)
 pkts bytes target     prot opt in     out     source               destination
  441 37384 oem_mangle_post  all  --  *      *       0.0.0.0/0            0.0.0.0/0
  441 37384 bw_mangle_POSTROUTING  all  --  *      *       0.0.0.0/0            0.0.0.0/0
  441 37384 idletimer_mangle_POSTROUTING  all  --  *      *       0.0.0.0/0            0.0.0.0/0

Chain bw_mangle_POSTROUTING (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      ipsec+  0.0.0.0/0            0.0.0.0/0
    0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            policy match dir out pol ipsec
  441 37384 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            MARK and 0xffefffff
  441 37384            all  --  *      *       0.0.0.0/0            0.0.0.0/0           match bpf pinned /sys/fs/bpf/netd_shared/prog_netd_skfilter_egress_xtbpf

Chain idletimer_mangle_POSTROUTING (1 references)
 pkts bytes target     prot opt in     out     source               destination
  100  9824 IDLETIMER  all  --  *      sipa_eth0  0.0.0.0/0            0.0.0.0/0            timeout:10 label:0 send_nl_msg

Chain oem_mangle_post (1 references)
 pkts bytes target     prot opt in     out     source               destination

Chain routectrl_mangle_INPUT (1 references)
 pkts bytes target     prot opt in     out     source               destination
   60 11173 MARK       all  --  sipa_eth0 *       0.0.0.0/0            0.0.0.0/0            MARK xset 0x30064/0xffefffff
  297 78686 MARK       all  --  eth0   *       0.0.0.0/0            0.0.0.0/0            MARK xset 0x30066/0xffefffff

Chain tetherctrl_mangle_FORWARD (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 TCPMSS     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp flags:0x02/0x02 TCPMSS clamp to PMTU

Chain wakeupctrl_mangle_INPUT (1 references)
 pkts bytes target     prot opt in     out     source               destination
inspur-itgw:/ # [  647.659908]c3 [ T1220] systemserver cmd2 , get para: ( 50)







130|uis7885_2h10:/data/local/ubuntu/home/android # ./ip_monitor





ifinfomsg: 0, 0, 1, 32,1003,0
  Name: eth0
unknow link down or not running
[LINK] created: eth0 (index 32)
  MAC: 52:c0:c1:be:59:98
loop_cnt: 1
[ADDR] removed: 10.180.146.38/24
  Broadcast: 10.180.146.255
loop_cnt: 1
[ROUTE] removed:
  Destination: 10.180.146.0/24
  Type: unicast
  Interface: eth0
  Table Num: 254
  Table name: main (254)
  Protocol: kernel
  Scope: link
  Preferred Source: 10.180.146.38
loop_cnt: 1
[ROUTE] removed:
  Destination: 10.180.146.255/32
  Type: broadcast
  Interface: eth0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: link
  Preferred Source: 10.180.146.38
loop_cnt: 1
[ROUTE] removed:
  Destination: 10.180.146.0/32
  Type: broadcast
  Interface: eth0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: link
  Preferred Source: 10.180.146.38
loop_cnt: 1
[ROUTE] removed:
  Destination: 10.180.146.38/32
  Type: local
  Interface: eth0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: host
  Preferred Source: 10.180.146.38
loop_cnt: 1
[ROUTE] removed:
  Destination: 172.17.0.0/16
  Type: unicast
  Interface: docker0
  Table Num: 1032
  Table name: unknow (1032)
  Protocol: boot
  Scope: link
loop_cnt: 1
[ROUTE] added:
  Destination: 192.168.31.0/24
  Type: unicast
  Interface: eth0
  Table Num: 1015
  Table name: unknow (1015)
  Protocol: boot
  Scope: link
loop_cnt: 1











ifinfomsg: 0, 0, 1, 32,11043,0
  Name: eth0
unknow link up-running
[LINK] created: eth0 (index 32)
  MAC: 52:c0:c1:be:59:98
loop_cnt: 1
[ADDR] added: 10.180.146.38/24
  Broadcast: 10.180.146.255
loop_cnt: 1
[ROUTE] added:
  Destination: 10.180.146.38/32
  Type: local
  Interface: eth0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: host
  Preferred Source: 10.180.146.38
loop_cnt: 1
[ROUTE] added:
  Destination: 10.180.146.255/32
  Type: broadcast
  Interface: eth0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: link
  Preferred Source: 10.180.146.38
loop_cnt: 1
[ROUTE] added:
  Destination: 10.180.146.0/24
  Type: unicast
  Interface: eth0
  Table Num: 254
  Table name: main (254)
  Protocol: kernel
  Scope: link
  Preferred Source: 10.180.146.38
loop_cnt: 1
[ROUTE] added:
  Destination: 10.180.146.0/32
  Type: broadcast
  Interface: eth0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: link
  Preferred Source: 10.180.146.38
loop_cnt: 1
[ROUTE] added:
  Destination: 10.180.146.0/24
  Type: unicast
  Interface: eth0
  Table Num: 1032
  Table name: unknow (1032)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] added:
  Destination: 10.180.146.0/24
  Type: unicast
  Interface: eth0
  Table Num: 1000000032
  Table name: unknow (1000000032)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] added:
  Gateway: 10.180.146.254
  Interface: eth0
  Table Num: 1032
  Table name: unknow (1032)
  Protocol: static
  Scope: globa
loop_cnt: 1
[ROUTE] added:
  Destination: 172.17.0.0/16
  Type: unicast
  Interface: docker0
  Table Num: 1032
  Table name: unknow (1032)
  Protocol: boot
  Scope: link
loop_cnt: 1
ifinfomsg: 0, 0, 519, 15,80,1
  Name: sipa_eth0
unknow link down or not running
[LINK] created: sipa_eth0 (index 15)
  MAC: 62:cd:44:b1:7d:69
loop_cnt: 1



























ifinfomsg: 0, 0, 519, 15,100c1,1
  Name: sipa_eth0
unknow link up-running
[LINK] created: sipa_eth0 (index 15)
  MAC: 62:cd:44:b1:7d:69
loop_cnt: 1
[ROUTE] added:
  Destination: 10.0.0.0/8
  Type: unicast
  Interface: sipa_eth0
  Table Num: 254
  Table name: main (254)
  Protocol: kernel
  Scope: link
  Preferred Source: 10.167.45.153
loop_cnt: 1
[ROUTE] added:
  Destination: 10.0.0.0/32
  Type: broadcast
  Interface: sipa_eth0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: link
  Preferred Source: 10.167.45.153
loop_cnt: 1
[ROUTE] added:
  Destination: 10.255.255.255/32
  Type: broadcast
  Interface: sipa_eth0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: link
  Preferred Source: 10.167.45.153
loop_cnt: 1






uis7885_2h10:/ # ip rule
0:      from all lookup local
1:      from all lookup main
1004:   from 172.17.0.0/16 lookup eth0
1004:   from all to 172.17.0.0/16 lookup eth0
10000:  from all fwmark 0xc0000/0xd0000 lookup legacy_system
11000:  from all iif lo oif dummy0 uidrange 0-0 lookup dummy0
11000:  from all iif lo oif eth0 uidrange 0-0 lookup eth0
11000:  from all iif lo oif sipa_eth0 uidrange 0-0 lookup sipa_eth0
11000:  from all iif lo oif sipa_eth0 uidrange 0-0 lookup sipa_eth0
11000:  from all iif lo oif wlan0 uidrange 0-0 lookup wlan0
16000:  from all fwmark 0x10063/0x1ffff iif lo lookup local_network
16000:  from all fwmark 0x1006b/0x1ffff iif lo lookup eth0
16000:  from all fwmark 0x1006c/0x1ffff iif lo lookup sipa_eth0
16000:  from all fwmark 0x1006d/0x1ffff iif lo lookup sipa_eth0
16000:  from all fwmark 0x1006e/0x1ffff iif lo lookup wlan0
17000:  from all iif lo oif dummy0 lookup dummy0
17000:  from all iif lo oif eth0 lookup eth0
17000:  from all iif lo oif sipa_eth0 lookup sipa_eth0
17000:  from all iif lo oif sipa_eth0 lookup sipa_eth0
17000:  from all iif lo oif wlan0 lookup wlan0
18000:  from all fwmark 0x0/0x10000 lookup legacy_system
19000:  from all fwmark 0x0/0x10000 lookup legacy_network
20000:  from all fwmark 0x0/0x10000 lookup local_network
23000:  from all fwmark 0x6b/0x1ffff iif lo lookup eth0
23000:  from all fwmark 0x6c/0x1ffff iif lo lookup sipa_eth0
23000:  from all fwmark 0x6d/0x1ffff iif lo lookup sipa_eth0
23000:  from all fwmark 0x6e/0x1ffff iif lo lookup wlan0
31000:  from all fwmark 0x0/0xffff iif lo lookup eth0
31000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
31000:  from all fwmark 0x0/0xffff iif lo lookup 1003
32000:  from all unreachable
32000:  from all fwmark 0x0/0xffff iif lo lookup sipa_eth0
uis7885_2h10:/ # rou
route   routef  routel
uis7885_2h10:/ # route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         0.0.0.0         0.0.0.0         U     100    0        0 sipa_eth0
10.0.0.0        0.0.0.0         255.0.0.0       U     0      0        0 sipa_eth0
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan0
192.168.31.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.32.0    0.0.0.0         255.255.255.0   U     0      0        0 br-lan
uis7885_2h10:/ # ip route get 8.8.8.8
8.8.8.8 dev sipa_eth0 src 10.32.77.145 uid 0
    cache mtu 1400
uis7885_2h10:/ # ip route del default dev sipa_eth0 proto static scope link mtu 1400 pri 100
uis7885_2h10:/ #
uis7885_2h10:/ # ip route get 8.8.8.8
8.8.8.8 via 192.168.31.1 dev eth0 table eth0 src 192.168.31.67 uid 0
    cache
uis7885_2h10:/ # ip route show table eth0
default via 192.168.31.1 dev eth0 proto static
172.17.0.0/16 dev docker0 scope link linkdown
192.168.31.0/24 dev eth0 proto static scope link
uis7885_2h10:/ # ip route show table sipa_eth0
default dev sipa_eth0 proto static scope link mtu 1400
10.32.77.145 dev sipa_eth0 proto static scope link
uis7885_2h10:/ #
uis7885_2h10:/ #
uis7885_2h10:/ # ip route get 8.8.8.8
8.8.8.8 via 192.168.31.1 dev eth0 table eth0 src 192.168.31.67 uid 0
    cache
uis7885_2h10:/ # ip route show table main
10.0.0.0/8 dev sipa_eth0 proto kernel scope link src 10.32.77.145
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
192.168.2.0/24 dev wlan0 proto kernel scope link src 192.168.2.166
192.168.31.0/24 dev eth0 proto kernel scope link src 192.168.31.67
192.168.32.0/24 dev br-lan proto kernel scope link src 192.168.32.1
uis7885_2h10:/ #
uis7885_2h10:/ # ip route get 8.8.8.8
8.8.8.8 via 192.168.31.1 dev eth0 table eth0 src 192.168.31.67 uid 0
    cache
uis7885_2h10:/ #
uis7885_2h10:/ #
uis7885_2h10:/ #
uis7885_2h10:/ #
uis7885_2h10:/ #
uis7885_2h10:/ #
uis7885_2h10:/ # =========add 5G defualt GW into main=========
/system/bin/sh: =========add: inaccessible or not found
te del default dev sipa_eth0 proto static scope link mtu 1400 pri 100                                 <
RTNETLINK answers: No such process
efault dev sipa_eth0 proto static scope link mtu 1400 pri 100 table main                              <
uis7885_2h10:/ #
uis7885_2h10:/ # ip route show table main
default dev sipa_eth0 proto static scope link metric 100 mtu 1400
10.0.0.0/8 dev sipa_eth0 proto kernel scope link src 10.32.77.145
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
192.168.2.0/24 dev wlan0 proto kernel scope link src 192.168.2.166
192.168.31.0/24 dev eth0 proto kernel scope link src 192.168.31.67
192.168.32.0/24 dev br-lan proto kernel scope link src 192.168.32.1
uis7885_2h10:/ #
uis7885_2h10:/ # ip route get 8.8.8.8
8.8.8.8 dev sipa_eth0 src 10.32.77.145 uid 0
    cache mtu 1400
uis7885_2h10:/ #
uis7885_2h10:/ # ==============add eth0 default gW into main========
/system/bin/sh: ==============add: inaccessible or not found
127|uis7885_2h10:/ # ip route add default via 192.168.31.1 dev eth0 proto static pri 50 table main
uis7885_2h10:/ #
uis7885_2h10:/ #
uis7885_2h10:/ # ip route show table main
default via 192.168.31.1 dev eth0 proto static metric 50
default dev sipa_eth0 proto static scope link metric 100 mtu 1400
10.0.0.0/8 dev sipa_eth0 proto kernel scope link src 10.32.77.145
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
192.168.2.0/24 dev wlan0 proto kernel scope link src 192.168.2.166
192.168.31.0/24 dev eth0 proto kernel scope link src 192.168.31.67
192.168.32.0/24 dev br-lan proto kernel scope link src 192.168.32.1
uis7885_2h10:/ # rou
route   routef  routel
uis7885_2h10:/ # route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.31.1    0.0.0.0         UG    50     0        0 eth0
0.0.0.0         0.0.0.0         0.0.0.0         U     100    0        0 sipa_eth0
10.0.0.0        0.0.0.0         255.0.0.0       U     0      0        0 sipa_eth0
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan0
192.168.31.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.32.0    0.0.0.0         255.255.255.0   U     0      0        0 br-lan
uis7885_2h10:/ # ip route get 8.8.8.8
8.8.8.8 via 192.168.31.1 dev eth0 src 192.168.31.67 uid 0
    cache
uis7885_2h10:/ # ip route get 8.8.8.8
8.8.8.8 via 192.168.31.1 dev eth0 src 192.168.31.67 uid 0
    cache
uis7885_2h10:/ # ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=111 time=36.2 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=111 time=37.4 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=111 time=36.8 ms
64 bytes from 8.8.8.8: icmp_seq=4 ttl=111 time=36.7 ms
64 bytes from 8.8.8.8: icmp_seq=5 ttl=111 time=37.5 ms
64 bytes from 8.8.8.8: icmp_seq=6 ttl=111 time=36.6 ms
64 bytes from 8.8.8.8: icmp_seq=7 ttl=111 time=35.8 ms
64 bytes from 8.8.8.8: icmp_seq=8 ttl=111 time=36.3 ms
64 bytes from 8.8.8.8: icmp_seq=9 ttl=111 time=36.4 ms
^C
--- 8.8.8.8 ping statistics ---
9 packets transmitted, 9 received, 0% packet loss, time 8015ms
rtt min/avg/max/mdev = 35.818/36.672/37.542/0.513 ms
uis7885_2h10:/ #

loop_cnt: 1
[ROUTE] added:
  Interface: sipa_eth0
  Priority: 100
  Table Num: 254
  Table name: main (254)
  Protocol: static
  Scope: link
  MTU: 1400
loop_cnt: 1
[ROUTE] added:
  Gateway: 192.168.31.1
  Interface: eth0
  Priority: 50
  Table Num: 254
  Table name: main (254)
  Protocol: static
  Scope: globa
loop_cnt: 1


============================移除5G卡

ifinfomsg: 0, 0, 519, 15,80,1
  Name: sipa_eth0
unknow link down or not running
[LINK] created: sipa_eth0 (index 15)
  MAC: d2:14:23:50:34:f3
loop_cnt: 1
[ADDR] removed: 10.32.77.145/8
loop_cnt: 1
[ROUTE] removed:
  Destination: 10.32.77.145/32
  Type: local
  Interface: sipa_eth0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: host
  Preferred Source: 10.32.77.145
loop_cnt: 1





===============插入5G卡




ifinfomsg: 0, 0, 519, 15,100c1,1
  Name: sipa_eth0
unknow link up-running
[LINK] created: sipa_eth0 (index 15)
  MAC: d2:14:23:50:34:f3
loop_cnt: 1
[ADDR] added: 10.176.35.115/8
loop_cnt: 1
[ROUTE] added:
  Destination: 10.176.35.115/32
  Type: local
  Interface: sipa_eth0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: host
  Preferred Source: 10.176.35.115
loop_cnt: 1
[ROUTE] added:
  Destination: 10.0.0.0/8
  Type: unicast
  Interface: sipa_eth0
  Table Num: 254
  Table name: main (254)
  Protocol: kernel
  Scope: link
  Preferred Source: 10.176.35.115
loop_cnt: 1
[ROUTE] added:
  Destination: 10.0.0.0/32
  Type: broadcast
  Interface: sipa_eth0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: link
  Preferred Source: 10.176.35.115
loop_cnt: 1
[ROUTE] added:
  Destination: 10.255.255.255/32
  Type: broadcast
  Interface: sipa_eth0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: link
  Preferred Source: 10.176.35.115
loop_cnt: 1
[ROUTE] added:
  Interface: sipa_eth0
  Table Num: 1015
  Table name: unknow (1015)
  Protocol: static
  Scope: link
  MTU: 1400
loop_cnt: 1
[ROUTE] added:
  Destination: 10.176.35.115/32
  Type: unicast
  Interface: sipa_eth0
  Table Num: 1015
  Table name: unknow (1015)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] added:
  Destination: 10.176.35.115/32
  Type: unicast
  Interface: sipa_eth0
  Table Num: 1000000015
  Table name: unknow (1000000015)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] added:
  Priority: 100000
  Table Num: 1015
  Table name: unknow (1015)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] removed:
  Priority: 100000
  Table Num: 1015
  Table name: unknow (1015)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] added:
  Priority: 100000
  Table Num: 1015
  Table name: unknow (1015)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] removed:
  Priority: 100000
  Table Num: 1015
  Table name: unknow (1015)
  Protocol: static
  Scope: link
loop_cnt: 1




==========android 5G网络路由规则添加：  
=======-->linux 监测规程：路由表不为255,254和253;接口名称不为空;目的ip为0.0.0.0; (如果gw为0.0.0.0：直接使用接口名称添加 ip route add default dev sipa_eth0 proto static scope link mtu 1500 pri 100 table main，  如果gw不为0.0.0.0： ip route add default via 192.168.31.1 dev sipa_eth0 proto static pri 100 table main)
[ROUTE] added:
  Interface: sipa_eth0
  Table Num: 1015
  Table name: unknow (1015)
  Protocol: static
  Scope: link
  MTU: 1400
loop_cnt: 1
[ROUTE] added:
  Destination: 10.176.35.115/32
  Type: unicast
  Interface: sipa_eth0
  Table Num: 1015
  Table name: unknow (1015)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] added:
  Destination: 10.176.35.115/32
  Type: unicast
  Interface: sipa_eth0
  Table Num: 1000000015
  Table name: unknow (1000000015)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] added:
  Priority: 100000
  Table Num: 1015
  Table name: unknow (1015)
  Protocol: static
  Scope: link
loop_cnt: 1

==========android 以太网路由规则添加
=======-->linux 监测规程：路由表不为255,254和253;接口名称不为空;目的ip为0.0.0.0; (如果gw为0.0.0.0：直接使用接口名称添加 ip route add default dev eth0 pri 50 table main，  如果gw不为0.0.0.0： ip route add default via 192.168.31.1 dev eth0 pri 50 table main)
[ROUTE] added:
  Destination: 10.180.146.0/24
  Type: unicast
  Interface: eth0
  Table Num: 1032
  Table name: unknow (1032)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] added:
  Destination: 10.180.146.0/24
  Type: unicast
  Interface: eth0
  Table Num: 1000000032
  Table name: unknow (1000000032)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] added:
  Gateway: 10.180.146.254
  Interface: eth0
  Table Num: 1032
  Table name: unknow (1032)
  Protocol: static
  Scope: globa
loop_cnt: 1

==========android wifi路由规则
ifinfomsg: 0, 0, 1, 33,11003,0
  Name: wlan0
unknow link down or not running
[LINK] created: wlan0 (index 33)
  MAC: 36:cd:76:1b:13:e0
loop_cnt: 1
ifinfomsg: 0, 0, 1, 33,11043,0
  Name: wlan0
unknow link up-running
[LINK] created: wlan0 (index 33)
  MAC: 36:cd:76:1b:13:e0
loop_cnt: 1
[ADDR] added: 192.168.2.166/24
  Broadcast: 192.168.2.255
loop_cnt: 1
[ROUTE] added:
  Destination: 192.168.2.166/32
  Type: local
  Interface: wlan0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: host
  Preferred Source: 192.168.2.166
loop_cnt: 1
[ROUTE] added:
  Destination: 192.168.2.255/32
  Type: broadcast
  Interface: wlan0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: link
  Preferred Source: 192.168.2.166
loop_cnt: 1
[ROUTE] added:
  Destination: 192.168.2.0/24
  Type: unicast
  Interface: wlan0
  Table Num: 254
  Table name: main (254)
  Protocol: kernel
  Scope: link
  Preferred Source: 192.168.2.166
loop_cnt: 1
[ROUTE] added:
  Destination: 192.168.2.0/32
  Type: broadcast
  Interface: wlan0
  Table Num: 255
  Table name: local (255)
  Protocol: kernel
  Scope: link
  Preferred Source: 192.168.2.166
loop_cnt: 1
[ROUTE] added:
  Destination: 192.168.2.0/24
  Type: unicast
  Interface: wlan0
  Table Num: 1033
  Table name: unknow (1033)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] added:
  Destination: 192.168.2.0/24
  Type: unicast
  Interface: wlan0
  Table Num: 1000000033
  Table name: unknow (1000000033)
  Protocol: static
  Scope: link
loop_cnt: 1
[ROUTE] added:
  Gateway: 192.168.2.1
  Interface: wlan0
  Table Num: 1033
  Table name: unknow (1033)
  Protocol: static
  Scope: globa
loop_cnt: 1

根据上面的数据定义我们的结构体：
struct route_entry {
	char ifname[IF_NAMESIZE];
	int rt_id;
	char des_ip[64];
	char gw_ip[64];
	int metric;
}route_entry_t;


//配置文件：
{
	"desc":"用于配置android的路由规则优先级。比如有线网络>wifi>5G",
	"entries":[
		{
			"name":"eth0",
			"metric": 50
		},
		{
			"name":"eth1",
			"metric": 51
		},
		{
			"name":"wlan0",
			"metric": 100
		},
		{
			"name":"sipa_eth0",
			"metric": 150
		}
	]
}

uis7885_2h10:/ # cat /var/log/syslog | grep "insert the"
Mar  5 16:47:57 localhost rt_monitor: insert the gw_ip:10.180.146.254 into main table. cmd=ip route add default via 10.180.146.254 dev eth0 pri 50 table main
Mar  5 16:47:57 localhost rt_monitor: insert the gw_ip:192.168.2.1 into main table. cmd=ip route add default via 192.168.2.1 dev wlan0 pri 100 table main
Mar  5 16:47:58 localhost rt_monitor: insert the gw_ip:10.180.146.254 into main table. cmd=ip route add default via 10.180.146.254 dev eth0 pri 50 table main
Mar  5 16:47:58 localhost rt_monitor: insert the gw_ip:192.168.2.1 into main table. cmd=ip route add default via 192.168.2.1 dev wlan0 pri 100 table main
Mar  5 16:59:23 localhost rt_monitor: insert the gw_ip:192.168.2.1 into main table. cmd=ip route add default via 192.168.2.1 dev wlan0 pri 100 table main
Mar  5 17:35:59 localhost rt_monitor: insert the gw_ip:10.180.146.254 into main table. cmd=ip route add default via 10.180.146.254 dev eth0 pri 50 table main
Mar  5 17:35:59 localhost rt_monitor: insert the dev:sipa_eth0 into main table. cmd=ip route add default dev sipa_eth0 pri 150 table main
Mar  5 17:36:00 localhost rt_monitor: insert the gw_ip:10.180.146.254 into main table. cmd=ip route add default via 10.180.146.254 dev eth0 pri 50 table main
Mar  5 17:36:00 localhost rt_monitor: insert the dev:sipa_eth0 into main table. cmd=ip route add default dev sipa_eth0 pri 150 table main
Mar  5 17:43:08 localhost rt_monitor: insert the gw_ip:10.180.146.254 into main table. cmd=ip route add default via 10.180.146.254 dev eth0 pri 50 table main
Mar  5 17:43:08 localhost rt_monitor: insert the gw_ip:10.180.146.254 into main table. cmd=ip route add default via 10.180.146.254 dev eth0 pri 50 table main
Mar  5 17:49:48 localhost rt_monitor: insert the gw_ip:10.180.146.254 into main table. cmd=ip route add default via 10.180.146.254 dev eth0 pri 50 table main
Mar  5 17:52:28 localhost rt_monitor: insert the gw_ip:192.168.2.1 into main table. cmd=ip route add default via 192.168.2.1 dev wlan0 pri 100 table main
uis7885_2h10:/ # ip route show
default via 10.180.146.254 dev eth0 metric 50
default via 192.168.2.1 dev wlan0 metric 100
default dev sipa_eth0 scope link metric 150
10.0.0.0/8 dev sipa_eth0 proto kernel scope link src 10.175.0.156
10.180.146.0/24 dev eth0 proto kernel scope link src 10.180.146.68
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
192.168.2.0/24 dev wlan0 proto kernel scope link src 192.168.2.166
192.168.32.0/24 dev br-lan proto kernel scope link src 192.168.32.1
uis7885_2h10:/ #